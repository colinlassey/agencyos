// Prisma schema for AgencyOS MVP

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  DEVELOPER
  CLIENT
}

enum ClientStage {
  LEAD
  ONBOARDING
  ACTIVE
  PAUSED
  ARCHIVED
}

enum ProjectStage {
  DISCOVERY
  DESIGN
  BUILD
  QA
  LAUNCH
  MAINTENANCE
}

enum PriorityLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TaskStatus {
  TODO
  DOING
  REVIEW
  DONE
  BLOCKED
}

enum ReviewStatus {
  PENDING
  APPROVED
  CHANGES_REQUESTED
}

enum FeedbackTargetType {
  CLIENT
  PROJECT
  TASK
}

enum TimeLogTargetType {
  PROJECT
  TASK
}

enum ChannelType {
  GENERAL
  DM
  PROJECT
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_UPDATED
  REVIEW_STATUS
  MESSAGE
  FILE_ADDED
  CALENDAR
}

model User {
  id                String                @id @default(cuid())
  email             String                @unique
  name              String?
  role              Role                  @default(DEVELOPER)
  avatarUrl         String?
  capacityHrsPerWeek Int?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  memberships       ProjectMember[]
  taskAssignments   TaskAssignment[]
  timeLogs          TimeLog[]
  feedback          Feedback[]            @relation("FeedbackAuthor")
  reviewSubmissions ReviewSubmission[]    @relation("ReviewSubmitter")
  reviewDecisions   ReviewSubmission[]    @relation("ReviewReviewer")
  messages          Message[]
  channels          ChannelParticipant[]
  notifications     Notification[]
  files             File[]
  clientAccess      ClientAccess[]
}

model Client {
  id              String           @id @default(cuid())
  name            String
  nameNormalized  String
  domain          String?
  stage           ClientStage      @default(LEAD)
  priority        PriorityLevel    @default(MEDIUM)
  notes           String?
  isDeleted       Boolean          @default(false)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  projects        Project[]
  feedback        Feedback[]       @relation("ClientFeedback")
  files           File[]
  contacts        ClientAccess[]

  @@unique([nameNormalized])
  @@unique([domain])
  @@index([stage])
}

model ClientAccess {
  id        String @id @default(cuid())
  client    Client @relation(fields: [clientId], references: [id])
  clientId  String
  user      User   @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime @default(now())

  @@unique([clientId, userId])
}

model Project {
  id             String             @id @default(cuid())
  name           String
  description    String?
  client         Client             @relation(fields: [clientId], references: [id])
  clientId       String
  stage          ProjectStage       @default(DISCOVERY)
  priority       PriorityLevel      @default(MEDIUM)
  dueDate        DateTime?
  isDeleted      Boolean            @default(false)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  tasks          Task[]
  memberships    ProjectMember[]
  feedback       Feedback[]
  reviewItems    ReviewSubmission[] @relation("ProjectReviewItems")
  timeLogs       TimeLog[]
  files          File[]
  channels       Channel[]

  @@index([clientId])
  @@index([stage])
  @@index([priority])
  @@index([dueDate])
}

model ProjectMember {
  id        String  @id @default(cuid())
  project   Project @relation(fields: [projectId], references: [id])
  projectId String
  user      User    @relation(fields: [userId], references: [id])
  userId    String
  role      Role    @default(DEVELOPER)
  createdAt DateTime @default(now())

  @@unique([projectId, userId])
  @@index([userId])
}

model Task {
  id            String          @id @default(cuid())
  title         String
  description   String?
  project       Project         @relation(fields: [projectId], references: [id])
  projectId     String
  status        TaskStatus      @default(TODO)
  priority      PriorityLevel   @default(MEDIUM)
  dueDate       DateTime?
  estimateHrs   Float?
  orderIndex    Int             @default(0)
  assigneeIds   String[]        @default([])
  isDeleted     Boolean         @default(false)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  assignments   TaskAssignment[]
  feedback      Feedback[]      @relation("TaskFeedback")
  reviewItems   ReviewSubmission[] @relation("TaskReviewItems")
  timeLogs      TimeLog[]

  @@index([projectId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([assigneeIds], type: Gin)
}

model TaskAssignment {
  id        String @id @default(cuid())
  task      Task   @relation(fields: [taskId], references: [id])
  taskId    String
  user      User   @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime @default(now())

  @@unique([taskId, userId])
  @@index([userId])
}

model Feedback {
  id              String             @id @default(cuid())
  content         String
  targetType      FeedbackTargetType
  targetId        String
  isClientVisible Boolean            @default(false)
  author          User               @relation("FeedbackAuthor", fields: [authorId], references: [id])
  authorId        String
  client          Client?            @relation("ClientFeedback", fields: [clientId], references: [id])
  clientId        String?
  project         Project?           @relation(fields: [projectId], references: [id])
  projectId       String?
  task            Task?              @relation("TaskFeedback", fields: [taskId], references: [id])
  taskId          String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([targetType, targetId])
  @@index([isClientVisible])
}

model ReviewSubmission {
  id             String        @id @default(cuid())
  project        Project       @relation("ProjectReviewItems", fields: [projectId], references: [id])
  projectId      String
  task           Task          @relation("TaskReviewItems", fields: [taskId], references: [id])
  taskId         String
  status         ReviewStatus  @default(PENDING)
  submittedBy    User          @relation("ReviewSubmitter", fields: [submittedById], references: [id])
  submittedById  String
  reviewer       User?         @relation("ReviewReviewer", fields: [reviewerId], references: [id])
  reviewerId     String?
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  respondedAt    DateTime?

  @@index([taskId])
  @@index([status])
}

model TimeLog {
  id         String            @id @default(cuid())
  targetType TimeLogTargetType
  targetId   String
  project    Project?          @relation(fields: [projectId], references: [id])
  projectId  String?
  task       Task?             @relation(fields: [taskId], references: [id])
  taskId     String?
  member     User              @relation(fields: [memberId], references: [id])
  memberId   String
  hours      Float
  date       DateTime
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  @@index([projectId])
  @@index([memberId, date])
}

model Channel {
  id          String               @id @default(cuid())
  type        ChannelType
  name        String?
  project     Project?             @relation(fields: [projectId], references: [id])
  projectId   String?
  isArchived  Boolean              @default(false)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  messages    Message[]
  participants ChannelParticipant[]

  @@index([type])
  @@index([projectId])
}

model ChannelParticipant {
  id        String   @id @default(cuid())
  channel   Channel  @relation(fields: [channelId], references: [id])
  channelId String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  joinedAt  DateTime @default(now())

  @@unique([channelId, userId])
}

model Message {
  id        String   @id @default(cuid())
  channel   Channel  @relation(fields: [channelId], references: [id])
  channelId String
  author    User     @relation(fields: [authorId], references: [id])
  authorId  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([channelId, createdAt])
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  user      User             @relation(fields: [userId], references: [id])
  userId    String
  payload   Json
  readAt    DateTime?
  createdAt DateTime         @default(now())

  @@index([userId, readAt])
}

model File {
  id         String    @id @default(cuid())
  name       String
  url        String
  mime       String
  size       Int
  version    Int        @default(1)
  client     Client?    @relation(fields: [clientId], references: [id])
  clientId   String?
  project    Project?   @relation(fields: [projectId], references: [id])
  projectId  String?
  uploader   User       @relation(fields: [uploaderId], references: [id])
  uploaderId String
  isDeleted  Boolean    @default(false)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@index([clientId])
  @@index([projectId])
}
